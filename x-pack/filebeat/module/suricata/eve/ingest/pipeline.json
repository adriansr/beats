{ "description": "Pipeline for parsing Suricata EVE logs"
, "processors":
  [ { "script":
      { "lang": "painless"
      , "source": "ctx['suricata'] = new HashMap(); ctx['suricata']['eve'] = ctx['json']; ctx.remove('json');"
      }
    }
  , {"convert":
      {"field": "suricata.eve.src_ip"
      ,"target_field": "source.ip"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.src_port"
      ,"target_field": "source.port"
      ,"type": "integer"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.dest_ip"
      ,"target_field": "destination.ip"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.dest_port"
      ,"target_field": "destination.port"
      ,"type": "integer"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.http.http_method"
      ,"target_field": "http.request.method"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.http.status"
      ,"target_field": "http.response.status_code"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.http.hostname"
      ,"target_field": "url.hostname"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.http.hostname"
      ,"target_field": "destination.domain"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.http.http_refer"
      ,"target_field": "http.request.referrer"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.fileinfo.filename"
      ,"target_field": "file.path"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.fileinfo.size"
      ,"target_field": "file.size"
      ,"type": "integer"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.http.http_user_agent"
      ,"target_field": "user_agent.original"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }

  , { "date":
      { "field": "suricata.eve.timestamp"
      , "target_field": "@timestamp"
      , "formats": ["ISO8601"]
      }
    }

  , { "lowercase":
      { "field": "suricata.eve.event_type"
      , "ignore_missing": true
      }
    }
  , { "set":
      { "field": "event.type"
      , "value": "{{suricata.eve.event_type}}"
      }
    }
  , {"convert":
      {"field": "suricata.eve.alert.category"
      ,"target_field": "message"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.alert.action"
      ,"target_field": "event.outcome"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.alert.severity"
      ,"target_field": "event.severity"
      ,"type": "integer"
      ,"ignore_missing": true
      }
    }
  , {"date":
      {"field": "suricata.eve.flow.start"
      ,"target_field": "event.start"
      ,"formats": ["ISO8601"]
      ,"ignore_failure": true
      }
    }
  , {"date":
      {"field": "suricata.eve.timestamp"
      ,"target_field": "event.end"
      , "formats": ["ISO8601"]
      ,"ignore_failure": true
      }
    }
  , { "script":
      { "lang": "painless"
      , "source": "Instant ins(def d){try{return Instant.parse(d);}catch(Exception e){return null;}}def ev=ctx['event'];if(ev!=null){def start=ins(ev['start']); def end=ins(ev['end']); if(start!=null && end!=null && !start.isAfter(end)) {ev['duration'] = Duration.between(start,end).toNanos();}}"
      }
    }
  , {"convert":
      {"field": "suricata.eve.proto"
      ,"target_field": "network.transport"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , { "lowercase":
      { "field": "network.transport"
      , "ignore_missing": true
      }
    }
  , {"convert":
      {"field": "suricata.eve.app_proto"
      ,"target_field": "network.protocol"
      ,"type": "string"
      ,"ignore_missing": true
      }
    }
  , { "lowercase":
      { "field": "network.protocol"
      , "ignore_missing": true
      }
    }
  , { "user_agent":
      { "field": "user_agent.original"
      , "target_field": "user_agent"
      , "ignore_missing": true
      }
    }
  , { "rename":
      { "field": "user_agent.os"
      , "target_field": "user_agent.temp_os"
      , "ignore_missing": true
      }
    }
  , { "rename":
      { "field": "user_agent.temp_os"
      , "target_field": "user_agent.os.full_name"
      , "ignore_missing": true
      }
    }
  , { "rename":
      { "field": "user_agent.os_name"
      , "target_field": "user_agent.os.name"
      , "ignore_missing": true
      }
    }
  , { "rename":
      { "field": "user_agent.os_version"
      , "target_field": "user_agent.os.version"
      , "ignore_missing": true
      }
    }
  , { "rename":
      { "field": "user_agent.os_major"
      , "target_field": "user_agent.os.major"
      , "ignore_missing": true
      }
    }
  , { "rename":
      { "field": "user_agent.os_minor"
      , "target_field": "user_agent.os.minor"
      , "ignore_missing": true
      }
    }

  , { "geoip":
      { "field": "source.ip"
      , "target_field": "source.geo"
      , "ignore_missing": true
      }
    }
  , { "geoip":
      { "field": "destination.ip"
      , "target_field": "destination.geo"
      , "ignore_missing": true
      }
    }

  ]
, "on_failure":
  [ { "set" :
      { "field" : "error.message"
      , "value" : "{{ _ingest.on_failure_message }}"
      }
    }
  ]
}
